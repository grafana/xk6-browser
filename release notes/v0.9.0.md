The xk6-browser module has been upgraded to work with `v0.9.0` ðŸŽ‰! This upgrade includes:

- Several breaking changes, one of which involves making `locator.click` asynchronous.
- `browserContext.addCookies` has now been implemented.
- `browserType.Connect` has been implemented so xk6-browser can now connect to an already running Chrome/Chromium browser instance.
- Web vitals are natively supported by the xk6-browser module.
- Improved support for running tests concurrently with multiple k6 instances and VUs.
- Lots of fixes and refactors.


## Breaking changes

- [xk6-browser#790](https://github.com/grafana/xk6-browser/pull/790) Convert `locator.click` to async to have feature parity with `page.click` and `elementHandle.click`. Users must remember to work with `promise.All` and `page.waitForNavigation()` when a click action results in navigation.

    A `location.click` action that doesn't result in navigation can be used like so:
    ```javascript
    const tails = page.locator("input[value='Bet on tails!']");
    await tails.click(),
    ```

    A `location.click` action that does result in a navigation can be used like so:
    ```javascript
    const tails = page.locator("input[value='Bet on tails!']");
    await Promise.all([
      page.waitForNavigation(),
      tails.click(),
    ]);
    ```

- [xk6-browser#817](https://github.com/grafana/xk6-browser/pull/817) We've removed `--no-sandbox` from the default Chrome launch arguments. Now Chrome will launch with a sandbox, which is a more secure way of running the browser. If you are running tests under a `root` user, the browser will no longer launch unless the `--no-sandbox` argument is supplied. You can still pass this flag when launching a new Chrome instance using the `args` parameter on `chromium.launch`:

    ```javascript
    const browser = chromium.launch({
      args: ['no-sandbox'],
    });
    ```

- [xk6-browser#844](https://github.com/grafana/xk6-browser/pull/844) Remove the exported `version` param from the root module. Users should from now on reference the k6 version instead of the xk6-browser version.
- [xk6-browser#838](https://github.com/grafana/xk6-browser/pull/838) Remove first meaningful paint metric. This metric is being deprecated across all the browsers, so we've removed it.


## New features

### `browserContext.addCookies` [xk6-browser#760](https://github.com/grafana/xk6-browser/pull/760)

Websites require cookies to help store session details which will be used by the backend to retrieve the state. For example, when a user logins into a website then the backend will store login session details in a cookie, which can be used in future actions performed on the website. For the given example, to speed up the test run, instead of having to first go through the login flow, it would be quicker to set a known valid cookie so that the user can easily test a different feature of the website. With this new feature cookies can be added to a `browserContext` and all new `page`s created from this `browserContext` will have the cookie assigned to them. Thanks @zucchinho for implementing the feature!

```javascript
const context = browser.newContext()
context.addCookies([{name: 'myCookie', value: 'hello world', url: 'https://test.k6.io'}])
const page = context.newPage()
```

### `browserType.Connect` [xk6-browser#800](https://github.com/grafana/xk6-browser/pull/800)

There are cases where the user may want to connect to a remote browser instance where they have more control over the browser lifecycle, such as when working in a resource bound environment. This feature enables users to connect to a manually started Chrome/Chromium browser instance. It's a simple case of replacing `browser.launch` with `browser.connect` and supplying the CDP url as the first argument. Not all `launch` options will work with `connect` since the browser instance should already have started prior to working with `connect`. Since we assume that the user had decided to take ownership of starting the browser, we have made `browser.close` a NOOP when working with `browser.connect`, so the user will need to close the browser themselves.

```javascript
const browser = chromium.connect('ws://127.0.0.1:1234/devtools/browser/e3bb7e53-ad0f-46f3-ae89-a8416868f4ce')
const page = browser.newPage();
```

### Web Vitals are now natively supported by the xk6-browser module [xk6-browser#836](https://github.com/grafana/xk6-browser/pull/836) [xk6-browser#847](https://github.com/grafana/xk6-browser/pull/847)

Web vitals are the defacto way for developers to measure their frontend performance using the core metrics:

- Largest contentful paint ([LCP](https://web.dev/lcp/))
- First input delay ([FID](https://web.dev/fid/))
- Cumulative layout shift ([CLS](https://web.dev/cls/))

These measurements are now calculated for all tests without any additional work from your side. Simply run your test as you have been doing and you will be presented with the new metrics in the output. This is the output after running the [examples/fillform.js](https://github.com/grafana/xk6-browser/blob/main/examples/fillform.js) script:

```bash
webvital_cumulative_layout_shift..........: avg=0        min=0        med=0        max=0        p(90)=0        p(95)=0       
webvital_cumulative_layout_shift_good.....: 1       0.323332/s
webvital_first_contentful_paint...........: avg=278.86ms min=141.1ms  med=229.39ms max=466.1ms  p(90)=418.76ms p(95)=442.43ms
webvital_first_contentful_paint_good......: 3       0.969995/s
webvital_first_input_delay................: avg=300Âµs    min=200Âµs    med=300Âµs    max=399.99Âµs p(90)=379.99Âµs p(95)=389.99Âµs
webvital_first_input_delay_good...........: 2       0.646663/s
webvital_interaction_to_next_paint........: avg=16ms     min=16ms     med=16ms     max=16ms     p(90)=16ms     p(95)=16ms    
webvital_interaction_to_next_paint_good...: 1       0.323332/s
webvital_largest_content_paint............: avg=303.6ms  min=141.1ms  med=303.6ms  max=466.1ms  p(90)=433.6ms  p(95)=449.85ms
webvital_largest_content_paint_good.......: 2       0.646663/s
webvital_time_to_first_byte...............: avg=205.23ms min=104.79ms med=188.39ms max=322.5ms  p(90)=295.67ms p(95)=309.08ms
webvital_time_to_first_byte_good..........: 3       0.969995/s
```

You may have noticed other metrics in there too. We rely on the [web-vitals](https://github.com/GoogleChrome/web-vitals) JS library which exposes a few more metrics, so we've left them in for you to experiment with.

You will no longer see `browser_first_contentful_paint` in the summary, and instead you can work with `webvital_first_contentful_paint`.

### UX improvements and enhancements

- [xk6-browser#788](https://github.com/grafana/xk6-browser/pull/788) Update the xk6-browser readme to highlight that it is now a module in k6.
- [xk6-browser#803](https://github.com/grafana/xk6-browser/pull/803) Warns the user if the `browser.close` method is called more than once.
- [xk6-browser#820](https://github.com/grafana/xk6-browser/pull/820) Add error handling to wildcard selectors, which cleans up the error output in the terminal.
- [xk6-browser#843](https://github.com/grafana/xk6-browser/pull/843) Remove the build step from github actions. From this release onwards, no new standalone xk6-browser binaries will be built and available from the [releases](https://github.com/grafana/xk6-browser/releases) section. The latest version of the xk6-browser module will be available in the k6 binary which can be found [here](https://github.com/grafana/k6/releases).

## Bug fixes

- [xk6-browser#781](https://github.com/grafana/xk6-browser/pull/781) Fix mapping of `response` object's function from `jSON` to `json`.
- [xk6-browser#779](https://github.com/grafana/xk6-browser/pull/779) Clear Zombie processes on panic.
- [xk6-browser#834](https://github.com/grafana/xk6-browser/pull/834) Fix `page.close` so that it closes the current page and not the whole browser context.

## Maintenance and internal improvements

- [xk6-browser#848](https://github.com/grafana/xk6-browser/pull/848) Allow multiple k6 instances to connect to one browser to run concurrent tests. This update empowers high-concurrency k6 browser testing with multiple VUs and instances. Furthermore, users can now connect to an existing browser instance and execute concurrent tests, which was not possible previously due to browser page handling limitations.
- [xk6-browser#776](https://github.com/grafana/xk6-browser/pull/776) Fix test for preset flags for chrome on darwin based systems.
- [xk6-browser#782](https://github.com/grafana/xk6-browser/pull/782) Refactor mapping of "special" functions to work with a `map`.
- [xk6-browser#783](https://github.com/grafana/xk6-browser/pull/783) Fix mapping by unmapping internal methods.
- [xk6-browser#797](https://github.com/grafana/xk6-browser/pull/797) Fix for multi browser close vu was missing in Context.
- [xk6-browser#796](https://github.com/grafana/xk6-browser/pull/796) Return an error from `browserContext.SetExtraHTTPHeaders` and handle panic in mapping layer.
- [xk6-browser#798](https://github.com/grafana/xk6-browser/pull/798) Add locator mapping test.
- [xk6-browser#799](https://github.com/grafana/xk6-browser/pull/799) Add a testing functionality to detect redundant mappings.
- [xk6-browser#802](https://github.com/grafana/xk6-browser/pull/802) Add assert log contains and log dump helpers.
- [xk6-browser#807](https://github.com/grafana/xk6-browser/pull/807) Fix incorrect keyboard key code on up/down key press.
- [xk6-browser#810](https://github.com/grafana/xk6-browser/pull/810) Rename ErrInternal to ErrFatal and use abort/interrupt.
- [xk6-browser#821](https://github.com/grafana/xk6-browser/pull/821) Upgrade to k6 v0.43.1.
- [xk6-browser#824](https://github.com/grafana/xk6-browser/pull/824) Refactor logger.New to accept FieldLogger.
- [xk6-browser#826](https://github.com/grafana/xk6-browser/pull/826) Fix Edge-case: Mapping fails if the extension code returns nil values.
- [xk6-browser#830](https://github.com/grafana/xk6-browser/pull/830) Update to k6-core master and fix BPool.
- [xk6-browser#832](https://github.com/grafana/xk6-browser/pull/832) Fix killing a browser process on panic if one of them is missing.
- [xk6-browser#819](https://github.com/grafana/xk6-browser/pull/819) Transition from Browser.Launch to Browser.Connect when a CDP url is provided in an env var.
